#!/usr/bin/env php
<?php
namespace coveralls\cli;
use coveralls\{Client};

/**
 * @var string The version number of this package.
 */
const VERSION = '2.0.0';

/**
 * Prints the usage information.
 */
function printUsage() {
  echo 'Send a Clover or LCOV coverage report to the Coveralls service.', PHP_EOL;
  echo PHP_EOL;
  echo 'Usage:', PHP_EOL;
  echo 'coveralls -f <file>', PHP_EOL;
  echo PHP_EOL;
  echo 'Options:', PHP_EOL;
  echo '-f, --file       path to the coverage report', PHP_EOL;
  echo '-h, --help       output usage information', PHP_EOL;
  echo '-v, --version    output the version number', PHP_EOL;
}

// Initialize the application.
@cli_set_process_title('Coveralls.php');
require_once is_file($path = __DIR__.'/../vendor/autoload.php') ? $path : __DIR__.'/../../../autoload.php';

// Parse the command line arguments.
$options = getopt('f:hv', ['file:', 'help', 'version']);

if (isset($options['h']) || isset($options['help'])) {
  printUsage();
  exit(0);
}

if (isset($options['v']) || isset($options['version'])) {
  echo VERSION, PHP_EOL;
  exit(0);
}

if (!isset($options['f']) && !isset($options['file'])) {
  printUsage();
  exit(1);
}

// Upload the coverage report.
try {
  $file = $options['f'] ?? $options['file'];
  if (!is_file($file)) throw new \RuntimeException('The specified file is not found.');

  $env = $_ENV ?: $_SERVER;
  $client = new Client($env['COVERALLS_ENDPOINT'] ?? Client::DEFAULT_ENDPOINT);
  $coverage = @file_get_contents($file);

  echo '[Coveralls] Submitting to ', $client->getEndPoint(), PHP_EOL;
  $client->upload($coverage);
}

catch (\Throwable $e) {
  echo $e->getMessage(), PHP_EOL;
  exit(2);
}
